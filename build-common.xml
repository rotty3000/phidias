<?xml version="1.0"?>
<!DOCTYPE project>

<project name="build-commmon" xmlns:artifact="antlib:org.apache.maven.artifact.ant">
	<property environment="env" />

	<property name="groupId" value="org.phidias.compile" />
	<property name="artifactId" value="phidias" />
	<property name="version" value="0.2.1" />

	<property name="maven-jar" value="dist/${artifactId}-${version}.jar" />
	<property name="maven-javadoc-jar" value="dist/${artifactId}-${version}-javadoc.jar" />
	<property name="maven-sources-jar" value="dist/${artifactId}-${version}-sources.jar" />
	<property name="maven-snapshots-repository-id" value="sonatype-nexus-snapshots" />
	<property name="maven-snapshots-repository-url" value="https://oss.sonatype.org/content/repositories/snapshots/" />
	<property name="maven-staging-repository-id" value="sonatype-nexus-staging" />
	<property name="maven-staging-repository-url" value="https://oss.sonatype.org/service/local/staging/deploy/maven2/" />

	<property file="${project.dir}/build.${user.name}.properties" />
	<property file="${project.dir}/build.${env.COMPUTERNAME}.properties" />
	<property file="${project.dir}/build.${env.HOST}.properties" />
	<property file="${project.dir}/build.${env.HOSTNAME}.properties" />
	<property file="${project.dir}/build.properties" />

	<tstamp>
		<format property="current.time" pattern="yyMMddhhmmss" />
	</tstamp>

	<path id="lib.classpath">
		<fileset dir="${project.dir}/lib" includes="*.jar" excludes="ant.jar" />
	</path>

	<path id="test.classpath">
		<fileset dir="${project.dir}/lib" includes="*.jar" />
		<fileset dir="${project.dir}/lib/test" includes="ant-junit.jar,junit.jar" />
		<path path="${project.dir}/classes" />
	</path>

	<path id="bundle.classpath">
		<path refid="lib.classpath" />
		<path path="${project.dir}/classes" />
		<path path="${project.dir}/test-classes" />
	</path>

	<taskdef classpathref="lib.classpath" resource="aQute/bnd/ant/taskdef.properties" />
	<taskdef classpathref="lib.classpath" resource="net/sf/antcontrib/antlib.xml" />
	<taskdef classpathref="test.classpath" name="junit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask"/>

	<target name="clean-bundle">
		<delete dir="classes" />
		<delete file="${ant.project.name}.jar" />
	</target>

	<target name="compile-bundle">
		<mkdir dir="classes" />

		<copy todir="classes">
			<fileset dir="src" excludes="**/*.java" />
		</copy>

		<javac
			classpathref="bundle.classpath"
			compiler="${javac.compiler}"
			debug="${javac.debug}"
			deprecation="${javac.deprecation}"
			destdir="classes"
			encoding="${javac.encoding}"
			includeAntRuntime="false"
			nowarn="${javac.nowarn}"
			srcdir="src"
		/>
	</target>

	<target name="dist" depends="jar-bundle" description="generate the distribution">
		<move file="org.phidias.compile.jar" tofile="${maven-jar}"/>

		<jar jarfile="${maven-sources-jar}">
			<fileset dir="src" />
		</jar>

		<javadoc classpathref="bundle.classpath" sourcepath="src" destdir="dist/javadoc" />

		<jar jarfile="${maven-javadoc-jar}">
			<fileset dir="dist/javadoc" />
		</jar>
	</target>

	<target name="jar-bundle" depends="clean-bundle,compile-bundle">
		<bnd
			classpath="classes"
			eclipse="false"
			exceptions="true"
			failok="false"
			files="bnd.bnd"
			output="."
			sourcepath="src"
		/>
	</target>

	<target name="publish-snapshot" depends="dist" description="Deploy a snapshot version to our Maven snapshot repository">
		<artifact:mvn>
			<arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
			<arg value="-Durl=${maven-snapshots-repository-url}" />
			<arg value="-DrepositoryId=${maven-snapshots-repository-id}" />
			<arg value="-DpomFile=pom.xml" />
			<arg value="-Dfile=${maven-jar}" />
		</artifact:mvn>
	</target>

	<target name="stage-release" depends="dist" description="Deploy a release version to Maven staging repository">
		<artifact:mvn>
			<arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
			<arg value="-Durl=${maven-staging-repository-url}" />
			<arg value="-DrepositoryId=${maven-staging-repository-id}" />
			<arg value="-DpomFile=pom.xml" />
			<arg value="-Dfile=${maven-jar}" />
			<arg value="-Pgpg" />
		</artifact:mvn>

		<artifact:mvn>
			<arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
			<arg value="-Durl=${maven-staging-repository-url}" />
			<arg value="-DrepositoryId=${maven-staging-repository-id}" />
			<arg value="-DpomFile=pom.xml" />
			<arg value="-Dfile=${maven-sources-jar}" />
			<arg value="-Dclassifier=sources" />
			<arg value="-Pgpg" />
		</artifact:mvn>

		<artifact:mvn>
			<arg value="org.apache.maven.plugins:maven-gpg-plugin:1.3:sign-and-deploy-file" />
			<arg value="-Durl=${maven-staging-repository-url}" />
			<arg value="-DrepositoryId=${maven-staging-repository-id}" />
			<arg value="-DpomFile=pom.xml" />
			<arg value="-Dfile=${maven-javadoc-jar}" />
			<arg value="-Dclassifier=javadoc" />
			<arg value="-Pgpg" />
		</artifact:mvn>
	</target>
</project>